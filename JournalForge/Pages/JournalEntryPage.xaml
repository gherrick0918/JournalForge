<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:JournalForge.ViewModels"
             xmlns:models="clr-namespace:JournalForge.Models"
             x:Class="JournalForge.Pages.JournalEntryPage"
             x:DataType="viewmodels:JournalEntryViewModel"
             Title="{Binding Title}">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="ðŸ’¾ Save"
                     Command="{Binding SaveCommand}"
                     Priority="0" />
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="Auto,*,Auto,Auto">
        
        <!-- Header -->
        <VerticalStackLayout Grid.Row="0" Padding="20,20,20,10" Spacing="10">
            <Label Text="âœï¸ Chronicle Your Journey âœï¸" 
                   Style="{StaticResource RPGHeaderLarge}"/>
            
            <!-- Entry Title -->
            <Entry Text="{Binding EntryTitle}"
                   Style="{StaticResource RPGEntry}"
                   Placeholder="Entry title (optional - will be auto-generated)"/>
        </VerticalStackLayout>

        <!-- Conversation Thread -->
        <ScrollView Grid.Row="1" Padding="20,0">
            <VerticalStackLayout Spacing="10">
                <CollectionView ItemsSource="{Binding ConversationMessages}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:ConversationMessage">
                            <Grid Padding="0,5">
                                <!-- AI Message (left-aligned) -->
                                <Frame BackgroundColor="{StaticResource RPGBlue}"
                                       BorderColor="{StaticResource RPGBlue}"
                                       CornerRadius="15"
                                       Padding="12"
                                       Margin="0,0,60,0"
                                       HorizontalOptions="Start"
                                       IsVisible="{Binding Sender, Converter={StaticResource StringEqualityConverter}, ConverterParameter=AI}">
                                    <VerticalStackLayout Spacing="5">
                                        <Label Text="{Binding Content}"
                                               TextColor="White"
                                               FontSize="14"
                                               LineBreakMode="WordWrap"/>
                                        <Label Text="{Binding Timestamp, StringFormat='{0:HH:mm}'}"
                                               TextColor="#E0E0E0"
                                               FontSize="10"
                                               HorizontalOptions="End"/>
                                    </VerticalStackLayout>
                                </Frame>
                                
                                <!-- User Message (right-aligned) -->
                                <Frame BackgroundColor="{StaticResource RPGGold}"
                                       BorderColor="{StaticResource RPGGold}"
                                       CornerRadius="15"
                                       Padding="12"
                                       Margin="60,0,0,0"
                                       HorizontalOptions="End"
                                       IsVisible="{Binding Sender, Converter={StaticResource StringEqualityConverter}, ConverterParameter=User}">
                                    <VerticalStackLayout Spacing="5">
                                        <Label Text="{Binding Content}"
                                               TextColor="{StaticResource RPGDarkBrown}"
                                               FontSize="14"
                                               LineBreakMode="WordWrap"/>
                                        <Label Text="{Binding Timestamp, StringFormat='{0:HH:mm}'}"
                                               TextColor="{StaticResource RPGDarkBrown}"
                                               FontSize="10"
                                               HorizontalOptions="End"/>
                                    </VerticalStackLayout>
                                </Frame>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>
        </ScrollView>

        <!-- Voice Recording Section -->
        <Frame Grid.Row="2" 
               Style="{StaticResource RPGCard}"
               Margin="20,10"
               IsVisible="{Binding RecordingStatus, Converter={StaticResource StringNotEmptyConverter}}">
            <VerticalStackLayout Spacing="8">
                <HorizontalStackLayout Spacing="15" HorizontalOptions="Center">
                    <Button Text="ðŸŽ™ï¸ Start Recording"
                            Style="{StaticResource RPGButtonSecondary}"
                            Command="{Binding StartRecordingCommand}"
                            IsVisible="{Binding IsRecording, Converter={StaticResource InverseBoolConverter}}"/>
                    <Button Text="â¹ï¸ Stop Recording"
                            Style="{StaticResource RPGButtonPrimary}"
                            Command="{Binding StopRecordingCommand}"
                            IsVisible="{Binding IsRecording}"/>
                </HorizontalStackLayout>
                <Label Text="{Binding RecordingStatus}" 
                       Style="{StaticResource RPGBodyText}"
                       FontSize="12"
                       HorizontalOptions="Center"/>
            </VerticalStackLayout>
        </Frame>

        <!-- Message Input Area -->
        <Frame Grid.Row="3" 
               BackgroundColor="{StaticResource RPGParchment}"
               BorderColor="{StaticResource RPGBrown}"
               CornerRadius="0"
               Padding="15,10"
               HasShadow="True">
            <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="10">
                <!-- Message Entry -->
                <Entry Grid.Column="0"
                       Text="{Binding CurrentMessage}"
                       Placeholder="Share your thoughts..."
                       BackgroundColor="White"
                       TextColor="{StaticResource RPGDarkBrown}"
                       PlaceholderColor="{StaticResource RPGTextSecondary}"
                       FontSize="14"
                       VerticalOptions="Center"
                       ReturnType="Send"
                       ReturnCommand="{Binding SendMessageCommand}"/>
                
                <!-- Help Button -->
                <Button Grid.Column="1"
                        Text="â“"
                        Command="{Binding RequestAIQuestionCommand}"
                        BackgroundColor="{StaticResource RPGBlue}"
                        TextColor="White"
                        WidthRequest="45"
                        HeightRequest="45"
                        CornerRadius="22"
                        FontSize="18"
                        Padding="0"
                        ToolTipProperties.Text="Ask AI for guidance"/>
                
                <!-- Send Button -->
                <Button Grid.Column="2"
                        Text="ðŸ“¤"
                        Command="{Binding SendMessageCommand}"
                        BackgroundColor="{StaticResource RPGGold}"
                        TextColor="{StaticResource RPGDarkBrown}"
                        WidthRequest="45"
                        HeightRequest="45"
                        CornerRadius="22"
                        FontSize="18"
                        Padding="0"/>
            </Grid>
        </Frame>
    </Grid>

</ContentPage>
