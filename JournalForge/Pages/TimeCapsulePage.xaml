<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:JournalForge.ViewModels"
             x:Class="JournalForge.Pages.TimeCapsulePage"
             x:DataType="viewmodels:TimeCapsuleViewModel"
             Title="{Binding Title}">

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="15">

            <!-- Header -->
            <Label Text="â° Time Capsule â°" 
                   Style="{StaticResource RPGHeaderLarge}"
                   Margin="0,10"/>

            <Label Text="Seal your thoughts for the future. Open them when the time is right." 
                   Style="{StaticResource RPGBodyText}"
                   HorizontalOptions="Center"
                   HorizontalTextAlignment="Center"
                   Margin="0,0,0,20"/>

            <!-- Create New Capsule Button -->
            <Button Text="ðŸ”’ Seal New Capsule"
                    Style="{StaticResource RPGButtonPrimary}"
                    Command="{Binding CreateNewCommand}"
                    IsVisible="{Binding IsCreatingNew, Converter={StaticResource InverseBoolConverter}}"
                    FontSize="18"/>

            <!-- Create New Capsule Form -->
            <Frame Style="{StaticResource RPGCard}"
                   IsVisible="{Binding IsCreatingNew}">
                <VerticalStackLayout Spacing="15">
                    <Label Text="ðŸ—ï¸ Create Time Capsule" 
                           Style="{StaticResource RPGHeaderMedium}"
                           TextColor="{StaticResource RPGGold}"/>

                    <!-- Title -->
                    <VerticalStackLayout Spacing="5">
                        <Label Text="Title" 
                               Style="{StaticResource RPGHeaderSmall}"/>
                        <Entry Text="{Binding NewCapsuleTitle}"
                               Style="{StaticResource RPGEntry}"
                               Placeholder="Name your time capsule..."/>
                    </VerticalStackLayout>

                    <!-- Message -->
                    <VerticalStackLayout Spacing="5">
                        <Label Text="Message to Future Self" 
                               Style="{StaticResource RPGHeaderSmall}"/>
                        <Editor Text="{Binding NewCapsuleMessage}"
                                Style="{StaticResource RPGEditor}"
                                Placeholder="Write a message to your future self..."
                                HeightRequest="200"/>
                    </VerticalStackLayout>

                    <!-- Unseal Date -->
                    <VerticalStackLayout Spacing="5">
                        <Label Text="Unseal Date" 
                               Style="{StaticResource RPGHeaderSmall}"/>
                        <DatePicker Date="{Binding UnsealDate}"
                                    MinimumDate="{x:Static x:DateTime.Now}"
                                    TextColor="{StaticResource RPGTextPrimary}"/>
                    </VerticalStackLayout>

                    <!-- Action Buttons -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="10" Margin="0,10,0,0">
                        <Button Text="ðŸ”’ Seal It!"
                                Style="{StaticResource RPGButtonPrimary}"
                                Command="{Binding SealCapsuleCommand}"
                                Grid.Column="0"/>
                        <Button Text="âŒ Cancel"
                                Style="{StaticResource RPGButtonSecondary}"
                                Command="{Binding CancelCommand}"
                                Grid.Column="1"/>
                    </Grid>
                </VerticalStackLayout>
            </Frame>

            <!-- Existing Capsules -->
            <Frame Style="{StaticResource RPGCard}">
                <VerticalStackLayout Spacing="10">
                    <Label Text="ðŸ“¦ Your Sealed Capsules" 
                           Style="{StaticResource RPGHeaderMedium}"
                           TextColor="{StaticResource RPGPurple}"/>

                    <CollectionView ItemsSource="{Binding Capsules}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame BackgroundColor="{StaticResource RPGCardBackground}"
                                       BorderColor="{StaticResource RPGDarkBrown}"
                                       CornerRadius="10"
                                       Padding="15"
                                       Margin="0,5">
                                    <VerticalStackLayout Spacing="10">
                                        <!-- Title -->
                                        <Label Text="{Binding Title}" 
                                               Style="{StaticResource RPGHeaderSmall}"/>

                                        <!-- Preview -->
                                        <Label Text="{Binding PreviewText}" 
                                               Style="{StaticResource RPGBodyText}"
                                               FontSize="12"/>

                                        <!-- Dates -->
                                        <HorizontalStackLayout Spacing="20">
                                            <Label>
                                                <Label.FormattedText>
                                                    <FormattedString>
                                                        <Span Text="Sealed: " 
                                                              FontFamily="OpenSansSemibold"
                                                              TextColor="{StaticResource RPGTextSecondary}"/>
                                                        <Span Text="{Binding SealedDate, StringFormat='{0:MMM dd, yyyy}'}"
                                                              TextColor="{StaticResource RPGTextPrimary}"/>
                                                    </FormattedString>
                                                </Label.FormattedText>
                                            </Label>

                                            <Label>
                                                <Label.FormattedText>
                                                    <FormattedString>
                                                        <Span Text="Unseals: " 
                                                              FontFamily="OpenSansSemibold"
                                                              TextColor="{StaticResource RPGTextSecondary}"/>
                                                        <Span Text="{Binding UnsealDate, StringFormat='{0:MMM dd, yyyy}'}"
                                                              TextColor="{StaticResource RPGTextPrimary}"/>
                                                    </FormattedString>
                                                </Label.FormattedText>
                                            </Label>
                                        </HorizontalStackLayout>

                                        <!-- Status -->
                                        <Label Text="{Binding IsUnsealed, StringFormat='Status: {0}'}"
                                               FontSize="10"
                                               TextColor="{StaticResource RPGTextSecondary}"/>

                                        <!-- Unseal Button -->
                                        <Button Text="ðŸ”“ Open Capsule"
                                                Style="{StaticResource RPGButtonPrimary}"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.UnsealCommand}"
                                                CommandParameter="{Binding .}"
                                                IsVisible="{Binding IsUnsealed, Converter={StaticResource InverseBoolConverter}}"
                                                FontSize="12"
                                                Padding="10,5"/>
                                    </VerticalStackLayout>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                        <CollectionView.EmptyView>
                            <Label Text="No time capsules yet. Create your first one!"
                                   Style="{StaticResource RPGBodyText}"
                                   HorizontalOptions="Center"
                                   Margin="20"/>
                        </CollectionView.EmptyView>
                    </CollectionView>
                </VerticalStackLayout>
            </Frame>

            <!-- Refresh Button -->
            <Button Text="ðŸ”„ Refresh"
                    Style="{StaticResource RPGButtonSecondary}"
                    Command="{Binding RefreshCommand}"
                    Margin="0,10"/>

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>
